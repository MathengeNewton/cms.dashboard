import{u as j,ci as M,j as a,C as P,a as s,G as p,F as L,a_ as O,e as C,a$ as F,aH as A,p as Q,Q as c,r as R,d as T,ao as q}from"./index-e5ac1c37.js";import"./react-redux-7b717b6c.js";import"./classnames-eea0979a.js";import{b as w}from"./payments-292c2f42.js";import{u as z}from"./formik-4b8c99cc.js";import{r as N}from"./react-e483b31d.js";import{c as G}from"./collect.js-ebd014c9.js";import{e as H,a as U}from"./react-router-82cc6afb.js";import{u as X}from"./react-i18next-91d47f13.js";import{X as D}from"./react-feather-90dbe0b6.js";import{v as J}from"./uuid-4a60fe23.js";import"./hoist-non-react-statics-2fceee1f.js";import"./@babel-e5cbf021.js";import"./react-is-e8e5dbb3.js";import"./lodash-bd2b80f6.js";import"./dayjs-75976aa4.js";import"./i18next-076b76a4.js";import"./axios-60492c0c.js";import"./react-hot-toast-d3a0fddd.js";import"./goober-70b4b9ca.js";import"./react-query-557fee5a.js";import"./react-dom-ce3e84ee.js";import"./scheduler-765c72db.js";import"./@azure-485fd2d4.js";import"./@reduxjs-3eb15742.js";import"./immer-85efa438.js";import"./redux-fc7ec223.js";import"./reselect-26feef0e.js";import"./redux-thunk-ef899f4c.js";import"./jotai-4279821d.js";import"./react-router-dom-67fe6288.js";import"./@remix-run-dd360fb4.js";import"./styled-components-2e13d465.js";import"./tslib-b7af3ea6.js";import"./@emotion-4a2a218f.js";import"./stylis-60528643.js";import"./react-datepicker-27eb8381.js";import"./react-debounce-input-20b6d49d.js";import"./lodash.debounce-ddb7250b.js";import"./@headlessui-220c51a1.js";import"./react-icons-071f44cd.js";import"./@tippyjs-11b6b10a.js";import"./tippy.js-87d3e7d2.js";import"./@popperjs-0aa08b12.js";import"./react-use-57961871.js";import"./react-phone-number-input-4fffe465.js";import"./react-verification-input-7fc81ee7.js";import"./react-colorful-fdedf134.js";import"./@react-oauth-6ebaa241.js";import"./react-qr-code-d89187e6.js";import"./qr.js-8bf59ccc.js";import"./prop-types-20aec754.js";import"./react-select-0a6a834e.js";import"./@floating-ui-f24065be.js";import"./use-isomorphic-layout-effect-90624eb0.js";import"./memoize-one-297ddbcb.js";import"./@hello-pangea-bfa72c9a.js";import"./use-memo-one-4ec633fc.js";import"./css-box-model-096cf826.js";import"./tiny-invariant-bee4f299.js";import"./raf-schd-5404ed65.js";import"./array-move-3ca81c74.js";import"./antd-c1c66b30.js";import"./rc-util-6b529ca7.js";import"./@ant-design-6511c079.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./@ctrl-fb5a5473.js";import"./rc-resize-observer-f83f8b7d.js";import"./rc-motion-e4fc5c25.js";import"./rc-picker-0dcad4af.js";import"./@rc-component-79b9f5ef.js";import"./rc-pagination-2b5394e8.js";import"./rc-field-form-4872bfbf.js";import"./async-validator-dee29e8b.js";import"./@tinymce-7238a8f2.js";import"./pretty-bytes-5eb460d8.js";import"./react-dropzone-eadb3dbd.js";import"./file-selector-6cb2a621.js";import"./attr-accept-6df8d728.js";import"./react-string-replace-e94ae631.js";import"./currency.js-57f74176.js";import"./react-json-tree-c223e40a.js";import"./react-base16-styling-898a7ddc.js";import"./base16-823cae66.js";import"./color-65b618c9.js";import"./color-string-f5cd3c3e.js";import"./color-name-b7949e8c.js";import"./simple-swizzle-58fb3c22.js";import"./color-convert-946e453a.js";import"./lodash.curry-52fa8793.js";import"./react-turnstile-a0253d8c.js";import"./mitt-f7ef348c.js";import"./@sentry-71948bea.js";import"./@sentry-internal-c0f5a295.js";import"./use-sync-external-store-7794fa59.js";import"./deepmerge-15f827de.js";import"./lodash-es-87d1a1d5.js";import"./react-fast-compare-76c36d98.js";import"./tiny-warning-c932d744.js";function qt(){var v,b,f,h,_,g,S,$;const{id:d}=H(),[n]=X(),{data:i,isLoading:y}=w({id:d}),[m,u]=N.useState(),k=U(),l=j(),x=t=>{if(i){const e=(i==null?void 0:i.amount)-(i==null?void 0:i.refunded)-(i==null?void 0:i.applied);let r=0;return o.values.invoices.map(V=>{r=r+Number(V.amount)}),Math.min(e-r,t)}return t},B=()=>{if(i){const t=(i==null?void 0:i.amount)-(i==null?void 0:i.refunded)-(i==null?void 0:i.applied);let e=0;return o.values.invoices.map(r=>{e=e+Number(r.amount)}),t-e}return 0},o=z({enableReinitialize:!0,initialValues:{invoices:[]},onSubmit:t=>{c.processing(),u(void 0),R("PUT",C("/api/v1/payments/:id",{id:d}),t).then(e=>{c.success("updated_payment"),k(T("/payments/:id/edit",{id:e.data.data.id}))}).catch(e=>{var r;((r=e.response)==null?void 0:r.status)===422&&(u(e.response.data),c.dismiss())}).finally(()=>{o.setSubmitting(!1),q(["payments","invoices","clients","credits"])})}}),E=(t,e,r)=>{o.setFieldValue("invoices",[...o.values.invoices,{_id:J(),amount:e,credit_id:"",invoice_id:t,number:r}])},I=t=>{o.setFieldValue("invoices",o.values.invoices.filter(e=>e._id!==t))};return N.useEffect(()=>{let t=0;o.values.invoices.map(e=>{t=t+Number(e.amount)})},[o.values.invoices]),M({onClick:()=>o.submitForm(),disableSaveButton:o.isSubmitting},[o.values,o.isSubmitting]),a(P,{title:n("apply_payment"),children:[s(p,{leftSide:n("number"),children:i==null?void 0:i.number}),i&&i.client&&a(L,{children:[s(p,{leftSide:n("amount"),children:l((i==null?void 0:i.amount)-(i==null?void 0:i.refunded),(v=i.client)==null?void 0:v.country_id,(b=i.client)==null?void 0:b.settings.currency_id)}),s(p,{leftSide:n("applied"),children:l(i==null?void 0:i.applied,(f=i.client)==null?void 0:f.country_id,(h=i.client)==null?void 0:h.settings.currency_id)}),a(p,{leftSide:n("unapplied"),children:[l((i==null?void 0:i.amount)-(i==null?void 0:i.refunded)-(i==null?void 0:i.applied),(_=i.client)==null?void 0:_.country_id,(g=i.client)==null?void 0:g.settings.currency_id),o.values.invoices.length>=1&&`  - (${l(B(),(S=i.client)==null?void 0:S.country_id,($=i.client)==null?void 0:$.settings.currency_id)} ${n("remaining")})`]})]}),a(p,{leftSide:n("invoices"),children:[i!=null&&i.client_id?s(O,{endpoint:C(`/api/v1/invoices?payable=${i==null?void 0:i.client_id}&per_page=100`),inputOptions:{value:"id"},entryOptions:{id:"id",value:"id",label:"name",searchable:"number",dropdownLabelFn:t=>{var e,r;return`${n("invoice_number_short")}${t.number} - ${n("balance")} ${l(t.balance,(e=i.client)==null?void 0:e.country_id,(r=i.client)==null?void 0:r.settings.currency_id)}`}},onChange:({resource:t})=>t?E(t.id,x(t.balance),t.number):null,initiallyVisible:y,exclude:G(o.values.invoices).pluck("invoice_id").toArray(),clearInputAfterSelection:!0}):null,(m==null?void 0:m.errors.invoices)&&s("div",{className:"py-2",children:s(F,{type:"danger",children:m.errors.invoices})})]}),o.values.invoices.map((t,e)=>a(p,{leftSide:n("applied"),children:[a("div",{className:"flex items-center space-x-2",children:[s(A,{disabled:!0,label:n("invoice_number"),value:t.number}),s(A,{type:"number",label:n("amount_received"),id:`invoices[${e}].amount`,onChange:o.handleChange,value:t.amount}),s(Q,{className:"mt-7",behavior:"button",type:"minimal",onClick:()=>I(t._id),children:s(D,{})})]}),(m==null?void 0:m.errors[`invoices.${[e]}.invoice_id`])&&s("div",{className:"py-2",children:s(F,{type:"danger",children:m.errors[`invoices.${[e]}.invoice_id`]})})]},e))]})}export{qt as default};
