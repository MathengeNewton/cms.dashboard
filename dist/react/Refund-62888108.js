import{u as H,cj as N,Q as v,r as x,e as M,ao as Q,ci as T,j as h,C as O,a as o,G as l,aH as p,o as q,a$ as y,H as w,p as z,as as C}from"./index-e5ac1c37.js";import"./react-redux-7b717b6c.js";import"./classnames-eea0979a.js";import{b as D}from"./payments-292c2f42.js";import{u as I}from"./formik-4b8c99cc.js";import{r as d}from"./react-e483b31d.js";import{c as L}from"./collect.js-ebd014c9.js";import{e as U,a as X}from"./react-router-82cc6afb.js";import{u as J}from"./react-i18next-91d47f13.js";import{X as K}from"./react-feather-90dbe0b6.js";import"./hoist-non-react-statics-2fceee1f.js";import"./@babel-e5cbf021.js";import"./react-is-e8e5dbb3.js";import"./lodash-bd2b80f6.js";import"./dayjs-75976aa4.js";import"./i18next-076b76a4.js";import"./axios-60492c0c.js";import"./react-hot-toast-d3a0fddd.js";import"./goober-70b4b9ca.js";import"./react-query-557fee5a.js";import"./react-dom-ce3e84ee.js";import"./scheduler-765c72db.js";import"./@azure-485fd2d4.js";import"./@reduxjs-3eb15742.js";import"./immer-85efa438.js";import"./redux-fc7ec223.js";import"./reselect-26feef0e.js";import"./redux-thunk-ef899f4c.js";import"./jotai-4279821d.js";import"./react-router-dom-67fe6288.js";import"./@remix-run-dd360fb4.js";import"./styled-components-2e13d465.js";import"./tslib-b7af3ea6.js";import"./@emotion-4a2a218f.js";import"./stylis-60528643.js";import"./react-datepicker-27eb8381.js";import"./react-debounce-input-20b6d49d.js";import"./lodash.debounce-ddb7250b.js";import"./@headlessui-220c51a1.js";import"./react-icons-071f44cd.js";import"./@tippyjs-11b6b10a.js";import"./tippy.js-87d3e7d2.js";import"./@popperjs-0aa08b12.js";import"./react-use-57961871.js";import"./react-phone-number-input-4fffe465.js";import"./react-verification-input-7fc81ee7.js";import"./uuid-4a60fe23.js";import"./react-colorful-fdedf134.js";import"./@react-oauth-6ebaa241.js";import"./react-qr-code-d89187e6.js";import"./qr.js-8bf59ccc.js";import"./prop-types-20aec754.js";import"./react-select-0a6a834e.js";import"./@floating-ui-f24065be.js";import"./use-isomorphic-layout-effect-90624eb0.js";import"./memoize-one-297ddbcb.js";import"./@hello-pangea-bfa72c9a.js";import"./use-memo-one-4ec633fc.js";import"./css-box-model-096cf826.js";import"./tiny-invariant-bee4f299.js";import"./raf-schd-5404ed65.js";import"./array-move-3ca81c74.js";import"./antd-c1c66b30.js";import"./rc-util-6b529ca7.js";import"./@ant-design-6511c079.js";import"./resize-observer-polyfill-0f9f8adb.js";import"./@ctrl-fb5a5473.js";import"./rc-resize-observer-f83f8b7d.js";import"./rc-motion-e4fc5c25.js";import"./rc-picker-0dcad4af.js";import"./@rc-component-79b9f5ef.js";import"./rc-pagination-2b5394e8.js";import"./rc-field-form-4872bfbf.js";import"./async-validator-dee29e8b.js";import"./@tinymce-7238a8f2.js";import"./pretty-bytes-5eb460d8.js";import"./react-dropzone-eadb3dbd.js";import"./file-selector-6cb2a621.js";import"./attr-accept-6df8d728.js";import"./react-string-replace-e94ae631.js";import"./currency.js-57f74176.js";import"./react-json-tree-c223e40a.js";import"./react-base16-styling-898a7ddc.js";import"./base16-823cae66.js";import"./color-65b618c9.js";import"./color-string-f5cd3c3e.js";import"./color-name-b7949e8c.js";import"./simple-swizzle-58fb3c22.js";import"./color-convert-946e453a.js";import"./lodash.curry-52fa8793.js";import"./react-turnstile-a0253d8c.js";import"./mitt-f7ef348c.js";import"./@sentry-71948bea.js";import"./@sentry-internal-c0f5a295.js";import"./use-sync-external-store-7794fa59.js";import"./deepmerge-15f827de.js";import"./lodash-es-87d1a1d5.js";import"./react-fast-compare-76c36d98.js";import"./tiny-warning-c932d744.js";function qe(){var _;const{id:$}=U(),{data:i}=D({id:$}),G=H(),{data:u}=N({id:i==null?void 0:i.company_gateway_id,queryParams:"include=gateway",enabled:!!(i!=null&&i.company_gateway_id)}),[s]=J(),[n,g]=d.useState(),[c,b]=d.useState([]),[f,E]=d.useState(!1),[F,k]=d.useState(!1),[S,A]=d.useState(!1),R=X(),r=I({enableReinitialize:!0,initialValues:{id:i==null?void 0:i.id,date:i==null?void 0:i.date,invoices:[]},onSubmit:t=>{v.processing(),g(void 0);let e="/api/v1/payments/refund?&email_receipt=:email";S&&(e+="&gateway_refund=true"),x("POST",M(e,{email:f}),t).then(()=>{v.success("refunded_payment"),R("/payments")}).catch(a=>{var m;((m=a.response)==null?void 0:m.status)===422&&(g(a.response.data),v.dismiss())}).finally(()=>{r.setSubmitting(!1),Q(["payments"])})}}),j=t=>{const e=i==null?void 0:i.paymentables.find(({invoice_id:a})=>a===t.id);return e?e.amount-e.refunded:0},B=t=>{var a,m;const e=i==null?void 0:i.paymentables.find(({invoice_id:V})=>V===t.id);return e?`${s("invoice")} #${t.number} - ${s("refundable")} (${G(e.amount-e.refunded,(a=i==null?void 0:i.client)==null?void 0:a.country_id,(m=i==null?void 0:i.client)==null?void 0:m.settings.currency_id)})`:""};d.useEffect(()=>{i&&Array.isArray(i.invoices)&&c.map(t=>{const e=i.invoices.find(a=>a.id==t);e&&r.setFieldValue("invoices",[...r.values.invoices,{amount:j(e),invoice_id:e==null?void 0:e.id,id:""}])})},[c]),d.useEffect(()=>{let t=0;r.values.invoices.map(e=>{t=t+Number(e.amount),b(c.filter(a=>a!=e.invoice_id))})},[r.values.invoices]),d.useEffect(()=>{if(u){const t=u.data.data.gateway,e=Object.values(t.options).some(a=>a.refund);k(e)}},[u]);const P=()=>{var e;const t=L(r==null?void 0:r.values.invoices).pluck("invoice_id");return(e=i==null?void 0:i.invoices)==null?void 0:e.filter(a=>!t.contains(a.id))};return T({onClick:()=>r.handleSubmit(),disableSaveButton:r.isSubmitting||!r.values.invoices.length},[r.values,r.isSubmitting]),h(O,{title:s("refund_payment"),children:[o(l,{leftSide:s("number"),children:o(p,{disabled:!0,value:i==null?void 0:i.number})}),i&&o(l,{leftSide:s("amount"),children:o(p,{disabled:!0,value:(i==null?void 0:i.amount)-(i==null?void 0:i.refunded)})}),o(l,{leftSide:s("applied"),children:o(p,{disabled:!0,value:i==null?void 0:i.applied})}),o(l,{leftSide:s("date"),children:o(p,{type:"date",value:r.values.date,onValueChange:t=>r.setFieldValue("date",t)})}),h(l,{leftSide:s("invoices"),children:[o(q,{onChange:t=>{r.values.invoices.filter(e=>e.invoice_id==t.target.value).length<1&&b([...c,t.target.value]),t.target.value=""},withBlank:!0,children:(_=P())==null?void 0:_.map((t,e)=>o("option",{value:t.id,children:B(t)},e))}),(n==null?void 0:n.errors.invoices)&&o("div",{className:"py-2",children:o(y,{type:"danger",children:n.errors.invoices})})]}),o(w,{}),i&&Array.isArray(i.invoices)&&r.values.invoices.map((t,e)=>{const a=i.invoices.find(m=>m.id==t.invoice_id);if(a)return o(l,{leftSide:`${s("invoice")}: ${a==null?void 0:a.number}`,children:h("div",{className:"flex items-center space-x-2",children:[o(p,{id:`invoices[${e}].amount`,type:"number",value:r.values.invoices[e].amount,onChange:r.handleChange,errorMessage:n==null?void 0:n.errors[`invoices.${[e]}.invoice_id`]}),o(z,{behavior:"button",type:"minimal",onClick:()=>{r.setFieldValue("invoices",r.values.invoices.filter(m=>m.invoice_id!=t.invoice_id))},children:o(K,{})})]})},e)}),o(w,{}),o(l,{leftSide:s("send_email"),leftSideHelp:s("email_receipt"),children:o(C,{checked:f,onChange:()=>{E(!f)}})}),F&&o(l,{leftSide:s("gateway_refund"),leftSideHelp:s("gateway_refund_help"),children:o(C,{checked:S,onChange:t=>A(t)})}),(n==null?void 0:n.errors.id)&&o(y,{type:"danger",children:n.errors.id})]})}export{qe as default};
